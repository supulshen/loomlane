<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Complete your order checkout at Loom & Lane - Sri Lankan lifestyle products.">
    <meta name="keywords" content="checkout, payment, order, Sri Lankan products">
    <meta name="author" content="Loom & Lane">
    
    <title>Checkout | Loom & Lane</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
    <link rel="icon" type="image/png" href="assets/icons/favicon.png">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        /* Checkout Page Styles */
        .checkout-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--color-border);
        }
        
        .section-number {
            width: 40px;
            height: 40px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .form-control:invalid.was-validated,
        .form-control.is-invalid {
            border-color: var(--color-error);
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .form-control:valid.was-validated,
        .form-control.is-valid {
            border-color: var(--color-success);
        }
        
        .invalid-feedback {
            display: block;
            color: var(--color-error);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .order-summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--color-border);
        }
        
        .order-summary-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            flex-grow: 1;
        }
        
        .item-name {
            font-weight: 600;
            color: var(--color-text);
        }
        
        .item-meta {
            font-size: 0.85rem;
            color: var(--color-text-light);
        }
        
        .item-price {
            font-weight: 700;
            color: var(--color-primary);
        }
        
        .summary-totals {
            background: var(--bg-accent);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }
        
        .summary-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            padding-top: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            border-top: 2px solid var(--color-border);
        }
        
        .order-confirmation {
            display: none;
            text-align: center;
            padding: var(--spacing-xl) 0;
        }
        
        .confirmation-icon {
            width: 100px;
            height: 100px;
            background: var(--color-success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto var(--spacing-lg);
            animation: scaleIn 0.5s ease;
        }
        
        @keyframes scaleIn {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .order-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            font-family: var(--font-heading);
            margin: var(--spacing-md) 0;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-xl);
            position: relative;
        }
        
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-border);
            z-index: 0;
        }
        
        .step {
            text-align: center;
            flex: 1;
            position: relative;
            z-index: 1;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 2px solid var(--color-border);
            color: var(--color-text-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            transition: all var(--transition-fast);
        }
        
        .step.active .step-icon {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        
        .step.completed .step-icon {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
        
        .step-label {
            font-size: 0.85rem;
            color: var(--color-text-light);
        }
        
        .step.active .step-label {
            color: var(--color-primary);
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .progress-steps {
                flex-direction: column;
                gap: 1rem;
            }
            
            .progress-steps::before {
                display: none;
            }
        }
    </style>
</head>
<body>

    <!-- ========== NAVIGATION BAR ========== -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html" aria-label="Loom & Lane Home">
                <img src="assets/logo.svg" alt="Loom & Lane Logo">
            </a>
            
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars" style="color: var(--color-primary);"></i>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">
                            <i class="fas fa-shopping-bag"></i> Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">
                            <i class="fas fa-info-circle"></i> About
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">
                            <i class="fas fa-envelope"></i> Contact
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex align-items-center gap-3">
                    <!-- Search Icon -->
                    <button id="searchToggle" class="search-toggle" aria-label="Search products" title="Search">
                        <i class="fas fa-search"></i>
                    </button>
                    
                    <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <a href="cart.html" class="position-relative cart-icon" aria-label="Shopping cart">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cartCount" class="cart-badge">0</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ========== PAGE HEADER ========== -->
    <section class="py-4 page-header">
        <div class="container">
            <h1 class="mb-2">Secure Checkout</h1>
            <p class="mb-0">
                <i class="fas fa-home me-2"></i>
                <a href="index.html" class="breadcrumb-link">Home</a>
                <i class="fas fa-chevron-right mx-2" style="font-size: 0.8rem;"></i>
                <a href="cart.html" class="breadcrumb-link">Cart</a>
                <i class="fas fa-chevron-right mx-2" style="font-size: 0.8rem;"></i>
                <span>Checkout</span>
            </p>
        </div>
    </section>

    <!-- ========== CHECKOUT CONTENT ========== -->
    <section class="py-5">
        <div class="container">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="step-label">Cart</div>
                </div>
                <div class="step active">
                    <div class="step-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="step-label">Information</div>
                </div>
                <div class="step">
                    <div class="step-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="step-label">Confirmation</div>
                </div>
            </div>

            <!-- Checkout Form -->
            <div id="checkoutForm" class="row">
                <div class="col-lg-7">
                    <!-- Customer Information -->
                    <div class="checkout-section">
                        <div class="section-header">
                            <div class="section-number">1</div>
                            <div>
                                <h4 class="mb-0">Customer Information</h4>
                                <small class="text-muted">Please fill in your details</small>
                            </div>
                        </div>
                        
                        <form id="customerForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="fullName" class="form-label">
                                    Full Name <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="fullName" 
                                    required
                                    placeholder="Enter your full name"
                                    minlength="3">
                                <div class="invalid-feedback">
                                    Please enter your full name (minimum 3 characters).
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">
                                        Email Address <span class="text-danger">*</span>
                                    </label>
                                    <input 
                                        type="email" 
                                        class="form-control" 
                                        id="email" 
                                        required
                                        placeholder="your.email@example.com"
                                        pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">
                                    <div class="invalid-feedback">
                                        Please enter a valid email address.
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">
                                        Phone Number <span class="text-danger">*</span>
                                    </label>
                                    <input 
                                        type="tel" 
                                        class="form-control" 
                                        id="phone" 
                                        required
                                        placeholder="+94 77 123 4567"
                                        pattern="^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$">
                                    <div class="invalid-feedback">
                                        Please enter a valid phone number.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="address" class="form-label">
                                    Delivery Address <span class="text-danger">*</span>
                                </label>
                                <textarea 
                                    class="form-control" 
                                    id="address" 
                                    rows="3" 
                                    required
                                    placeholder="Enter your complete delivery address"
                                    minlength="10"></textarea>
                                <div class="invalid-feedback">
                                    Please enter your complete delivery address (minimum 10 characters).
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="city" class="form-label">
                                    City <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="city" required>
                                    <option value="" selected disabled>Select your city</option>
                                    <option value="Colombo">Colombo</option>
                                    <option value="Galle">Galle</option>
                                    <option value="Kandy">Kandy</option>
                                    <option value="Kalutara">Kalutara</option>
                                    <option value="Anuradhapura">Anuradhapura</option>
                                    <option value="Jaffna">Jaffna</option>
                                    <option value="Negombo">Negombo</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="invalid-feedback">
                                    Please select your city.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="postalCode" class="form-label">
                                    Postal Code <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="postalCode" 
                                    required
                                    placeholder="10000"
                                    pattern="[0-9]{5}"
                                    maxlength="5">
                                <div class="invalid-feedback">
                                    Please enter a valid 5-digit postal code.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="notes" class="form-label">
                                    Order Notes (Optional)
                                </label>
                                <textarea 
                                    class="form-control" 
                                    id="notes" 
                                    rows="2" 
                                    placeholder="Any special instructions for delivery?"></textarea>
                            </div>
                        </form>
                    </div>

                    <!-- Payment Method -->
                    <div class="checkout-section">
                        <div class="section-header">
                            <div class="section-number">2</div>
                            <div>
                                <h4 class="mb-0">Payment Method</h4>
                                <small class="text-muted">All transactions are secure</small>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3 p-3 border rounded">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cod" checked>
                            <label class="form-check-label" for="cod">
                                <strong><i class="fas fa-money-bill-wave text-success"></i> Cash on Delivery</strong>
                                <br>
                                <small class="text-muted">Pay when you receive your order</small>
                            </label>
                        </div>
                        
                        <div class="form-check p-3 border rounded" style="opacity: 0.6;">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="online" disabled>
                            <label class="form-check-label" for="online">
                                <strong><i class="fas fa-credit-card text-primary"></i> Online Payment</strong>
                                <br>
                                <small class="text-muted">Coming soon - Credit/Debit card payment</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="col-lg-5">
                    <div class="checkout-section" style="position: sticky; top: 80px;">
                        <h4 class="mb-4">
                            <i class="fas fa-receipt"></i> Order Summary
                        </h4>
                        
                        <div id="orderItemsList">
                            <!-- Order items will be loaded here -->
                        </div>
                        
                        <div class="summary-totals">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <strong id="checkoutSubtotal">LKR 0</strong>
                            </div>
                            <div class="summary-row">
                                <span>Tax (8%)</span>
                                <strong id="checkoutTax">LKR 0</strong>
                            </div>
                            <div class="summary-row">
                                <span>Shipping</span>
                                <strong id="checkoutShipping">LKR 0</strong>
                            </div>
                            <div class="summary-row summary-total">
                                <span>Total</span>
                                <span id="checkoutTotal">LKR 0</span>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-accent btn-lg w-100 mt-4" onclick="handlePlaceOrder()">
                            <i class="fas fa-lock"></i> Place Order
                        </button>
                        
                        <a href="cart.html" class="btn btn-outline w-100 mt-2">
                            <i class="fas fa-arrow-left"></i> Back to Cart
                        </a>
                        
                        <div class="mt-3 pt-3 text-center small text-muted" style="border-top: 1px solid var(--color-border);">
                            <i class="fas fa-shield-alt text-success"></i> Your information is secure<br>
                            <i class="fas fa-lock text-primary"></i> SSL encrypted checkout
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Confirmation -->
            <div id="orderConfirmation" class="order-confirmation">
                <div class="confirmation-icon">
                    <i class="fas fa-check"></i>
                </div>
                <h1 class="mb-3">Order Confirmed!</h1>
                <p class="lead text-muted mb-4">Thank you for your order. We've received it successfully.</p>
                
                <div class="order-number">
                    Order #<span id="orderNumber"></span>
                </div>
                
                <div class="checkout-section mx-auto" style="max-width: 600px; text-align: left;">
                    <h5 class="mb-3"><i class="fas fa-user-circle"></i> Customer Details</h5>
                    <div class="mb-2"><strong>Name:</strong> <span id="confirmName"></span></div>
                    <div class="mb-2"><strong>Email:</strong> <span id="confirmEmail"></span></div>
                    <div class="mb-2"><strong>Phone:</strong> <span id="confirmPhone"></span></div>
                    <div class="mb-2"><strong>Address:</strong> <span id="confirmAddress"></span></div>
                    
                    <hr>
                    
                    <h5 class="mb-3"><i class="fas fa-box"></i> Order Summary</h5>
                    <div id="confirmItems"></div>
                    <div class="summary-totals mt-3">
                        <div class="summary-row summary-total">
                            <span>Total Paid</span>
                            <span id="confirmTotal">LKR 0</span>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>What's Next?</strong><br>
                        You will receive a confirmation email shortly. Your order will be processed within 1-2 business days.
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="index.html" class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-home"></i> Back to Home
                    </a>
                    <a href="products.html" class="btn btn-outline btn-lg">
                        <i class="fas fa-shopping-bag"></i> Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== FOOTER ========== -->
    <footer class="footer">
        <div class="container">
            <div class="row g-4">
                <div class="col-lg-4 col-md-6">
                    <img src="assets/logo.svg" alt="Loom & Lane" class="footer-logo logo-dark">
                    <img src="assets/logo-light.svg" alt="Loom & Lane" class="footer-logo logo-light">
                    <p>Curated Sri Lankan lifestyle products celebrating traditional craftsmanship and sustainable living.</p>
                    <div class="footer-social mt-3">
                        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Pinterest"><i class="fab fa-pinterest"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6">
                    <h5>Quick Links</h5>
                    <a href="index.html">Home</a>
                    <a href="products.html">Products</a>
                    <a href="about.html">About Us</a>
                    <a href="contact.html">Contact</a>
                    <a href="cart.html">Shopping Cart</a>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h5>Customer Service</h5>
                    <a href="shipping.html">Shipping Policy</a>
                    <a href="returns.html">Return Policy</a>
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="feedback.html">Feedback</a>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h5>Our Branches</h5>
                    <div class="branch-card mb-2">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="branch-info">
                            <strong>Colombo</strong>
                            <p class="mb-0">123 Galle Road, Colombo 03</p>
                        </div>
                    </div>
                    <div class="branch-card mb-2">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="branch-info">
                            <strong>Galle</strong>
                            <p class="mb-0">45 Lighthouse Street, Galle Fort</p>
                        </div>
                    </div>
                    <div class="branch-card">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="branch-info">
                            <strong>Kandy</strong>
                            <p class="mb-0">78 Peradeniya Road, Kandy</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="mb-0">&copy; 2025 Loom & Lane. All rights reserved. | Crafted with <i class="fas fa-heart text-accent"></i> in Sri Lanka</p>
            </div>
        </div>
    </footer>

    <!-- ========== TOAST CONTAINER ========== -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

    <!-- ========== SCRIPTS ========== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <!-- Back to Top Button -->
    <button id="backToTop" class="back-to-top" aria-label="Back to top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <script src="js/theme.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/main.js"></script>
    <script src="js/chatbot.js"></script>
    
    <script>
        // ========== CHECKOUT PAGE LOGIC ==========
        
        const TAX_RATE = 0.08;
        const FREE_SHIPPING_THRESHOLD = 5000;
        const STANDARD_SHIPPING = 500;
        
        let orderData = {
            items: [],
            subtotal: 0,
            tax: 0,
            shipping: 0,
            total: 0
        };
        
        /**
         * Load checkout page
         * 
         * IMPORTANT: fetch() requires a local server (e.g., Live Server extension) 
         * due to browser CORS security policies.
         */
        async function loadCheckoutPage() {
            try {
                // Check if cart is empty
                const cartItems = cartManager.getItems();
                
                if (cartItems.length === 0) {
                    showToast('Empty Cart', 'Your cart is empty. Please add items before checkout.', 'warning');
                    setTimeout(() => {
                        window.location.href = 'products.html';
                    }, 2000);
                    return;
                }
                
                // Simulate realistic loading delay (200ms)
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Load product data (requires local server)
                const response = await fetch('data/products.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.products || !Array.isArray(data.products)) {
                    throw new Error('Invalid data structure');
                }
                
                const allProducts = data.products;
                
                // Match cart items with product details
                orderData.items = cartItems.map(cartItem => {
                    const product = allProducts.find(p => p.id === cartItem.id);
                    return {
                        ...cartItem,
                        productData: product
                    };
                }).filter(item => item.productData);
                
                console.log(`✓ Successfully loaded checkout with ${orderData.items.length} items`);
                
                // Calculate totals
                calculateCheckoutTotals();
                
                // Display order summary
                displayOrderSummary();
                
            } catch (error) {
                console.error('❌ Error loading checkout:', error);
                console.error('Make sure you are running this site with a local server (e.g., Live Server)');
                showToast('Error', 'Failed to load checkout. Please ensure you are using a local server.', 'error');
            }
        }
        
        /**
         * Calculate checkout totals
         */
        function calculateCheckoutTotals() {
            // Calculate subtotal
            orderData.subtotal = orderData.items.reduce((sum, item) => {
                return sum + (item.productData.price * item.quantity);
            }, 0);
            
            // Calculate tax
            orderData.tax = orderData.subtotal * TAX_RATE;
            
            // Calculate shipping
            orderData.shipping = orderData.subtotal >= FREE_SHIPPING_THRESHOLD ? 0 : STANDARD_SHIPPING;
            
            // Calculate total
            orderData.total = orderData.subtotal + orderData.tax + orderData.shipping;
        }
        
        /**
         * Display order summary
         */
        function displayOrderSummary() {
            const orderItemsList = document.getElementById('orderItemsList');
            
            // Display items
            orderItemsList.innerHTML = orderData.items.map(item => {
                const product = item.productData;
                const itemTotal = product.price * item.quantity;
                
                return `
                    <div class="order-summary-item">
                        <div class="item-info">
                            <div class="item-name">${product.name}</div>
                            <div class="item-meta">
                                Qty: ${item.quantity}
                                ${item.color ? ` • Color: ${item.color}` : ''}
                                ${item.size ? ` • Size: ${item.size}` : ''}
                            </div>
                        </div>
                        <div class="item-price">${formatPrice(itemTotal)}</div>
                    </div>
                `;
            }).join('');
            
            // Display totals
            document.getElementById('checkoutSubtotal').textContent = formatPrice(orderData.subtotal);
            document.getElementById('checkoutTax').textContent = formatPrice(orderData.tax);
            
            const shippingElement = document.getElementById('checkoutShipping');
            if (orderData.shipping === 0) {
                shippingElement.innerHTML = '<span class="text-success fw-bold">FREE</span>';
            } else {
                shippingElement.textContent = formatPrice(orderData.shipping);
            }
            
            document.getElementById('checkoutTotal').textContent = formatPrice(orderData.total);
        }
        
        /**
         * Validate form
         */
        function validateForm() {
            const form = document.getElementById('customerForm');
            
            // Add 'was-validated' class to show validation states
            form.classList.add('was-validated');
            
            // Check if form is valid
            if (!form.checkValidity()) {
                // Find first invalid field and focus it
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                showToast('Validation Error', 'Please fill in all required fields correctly.', 'error');
                return false;
            }
            
            return true;
        }
        
        /**
         * Handle place order
         */
        function handlePlaceOrder() {
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Get form data
            const customerData = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                postalCode: document.getElementById('postalCode').value,
                notes: document.getElementById('notes').value
            };
            
            // Generate order number
            const orderNumber = 'LL' + Date.now().toString().slice(-8);
            
            // Show confirmation
            showOrderConfirmation(customerData, orderNumber);
            
            // Clear cart
            cartManager.clearCart();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        /**
         * Show order confirmation
         */
        function showOrderConfirmation(customerData, orderNumber) {
            // Hide checkout form
            document.getElementById('checkoutForm').style.display = 'none';
            
            // Show confirmation
            const confirmationSection = document.getElementById('orderConfirmation');
            confirmationSection.style.display = 'block';
            
            // Update progress steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                step.classList.add('completed');
            });
            
            // Fill in confirmation details
            document.getElementById('orderNumber').textContent = orderNumber;
            document.getElementById('confirmName').textContent = customerData.fullName;
            document.getElementById('confirmEmail').textContent = customerData.email;
            document.getElementById('confirmPhone').textContent = customerData.phone;
            document.getElementById('confirmAddress').textContent = 
                `${customerData.address}, ${customerData.city}, ${customerData.postalCode}`;
            
            // Display order items
            const confirmItems = document.getElementById('confirmItems');
            confirmItems.innerHTML = orderData.items.map(item => {
                const product = item.productData;
                return `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${product.name} (x${item.quantity})</span>
                        <strong>${formatPrice(product.price * item.quantity)}</strong>
                    </div>
                `;
            }).join('');
            
            document.getElementById('confirmTotal').textContent = formatPrice(orderData.total);
            
            // Show success toast
            showToast('Order Placed!', 'Your order has been successfully placed.', 'success');
            
            // Store order in localStorage (for order history, if needed)
            try {
                const orders = JSON.parse(localStorage.getItem('loomLaneOrders') || '[]');
                orders.push({
                    orderNumber,
                    date: new Date().toISOString(),
                    customer: customerData,
                    items: orderData.items,
                    total: orderData.total
                });
                localStorage.setItem('loomLaneOrders', JSON.stringify(orders));
            } catch (error) {
                console.error('Error saving order:', error);
            }
        }
        
        // Initialize checkout page
        document.addEventListener('DOMContentLoaded', function() {
            loadCheckoutPage();
            updateCartCount();
            
            // Real-time validation
            const form = document.getElementById('customerForm');
            const inputs = form.querySelectorAll('input, textarea, select');
            
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (form.classList.contains('was-validated')) {
                        this.classList.add(this.checkValidity() ? 'is-valid' : 'is-invalid');
                    }
                });
                
                input.addEventListener('input', function() {
                    if (form.classList.contains('was-validated')) {
                        this.classList.remove('is-invalid', 'is-valid');
                        this.classList.add(this.checkValidity() ? 'is-valid' : 'is-invalid');
                    }
                });
            });
        });
    </script>
</body>
</html>
